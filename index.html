<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Driver Management System</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --success: #22c55e;
            --danger: #ef4444;
            --bg: #f8fafc;
            --text: #1e293b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 50px;
        }

        /* UTILS */
        .hide { display: none !important; }
        .card { background: #fff; border-radius: 12px; padding: 16px; margin: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* HEADER */
        .header {
            background: #fff;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid #e2e8f0;
        }
        .header img { height: 35px; }

        /* INPUTS & BUTTONS */
        input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px; /* Prevents iOS zoom on focus */
        }

        button {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border: none;
            border-radius: 8px;
            background: var(--primary);
            color: #fff;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        button:active { opacity: 0.7; }
        button.red { background: var(--danger); }
        button.green { background: var(--success); }
        button.outline { background: transparent; color: var(--primary); border: 1px solid var(--primary); }

        /* SHIFT SELECTOR */
        .shift-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        .shift-grid button {
            background: #e2e8f0;
            color: #64748b;
            margin: 0;
        }
        .shift-grid button.active {
            background: var(--primary);
            color: #fff;
        }

        /* DRIVER CARDS (Mobile Friendly Table Alternative) */
        .driver-card {
            border-left: 5px solid #cbd5e1;
            position: relative;
        }
        .driver-card.called { border-left-color: var(--success); }
        .driver-card .route-tag { 
            font-size: 12px; 
            font-weight: bold; 
            color: var(--primary); 
            text-transform: uppercase;
        }
        .driver-card .name { font-size: 18px; font-weight: 700; margin: 4px 0; }
        .driver-card .info { font-size: 14px; color: #64748b; margin-bottom: 10px; }
        .driver-card .actions { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .driver-card .status-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 20px;
            background: #f1f5f9;
        }

        /* LOGIN PAGE */
        .login-container {
            max-width: 400px;
            margin: 50px auto;
            text-align: center;
        }
    </style>
</head>

<body>

<div id="loginCard" class="login-container">
    <div class="card">
        <img src="download (1).png" alt="Logo" style="width: 120px; margin-bottom: 20px;">
        <h2 style="margin-top:0">Admin Login</h2>
        <input id="email" type="email" placeholder="Email Address">
        <input id="password" type="password" placeholder="Password">
        <button onclick="login()">Sign In</button>
    </div>
</div>

<div id="dashboard" class="hide">
    <header class="header">
        <img src="download (1).png" alt="Logo">
        <button class="red" style="width: auto; padding: 6px 15px; margin: 0;" onclick="logout()">Logout</button>
    </header>

    <div class="card">
        <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">Quick Actions</div>
        <div style="display: flex; gap: 8px;">
            <input type="file" id="excel" style="display:none" onchange="uploadExcel()">
            <button class="outline" onclick="document.getElementById('excel').click()">Import Excel</button>
            <button class="outline" onclick="exportCSV()">Export CSV</button>
        </div>
    </div>

    <div class="card">
        <h4 style="margin-top:0">Add / Edit Driver</h4>
        <input type="hidden" id="editKey">
        <div class="shift-grid">
            <button type="button" id="fs0" onclick="setFormShift(0)">1st</button>
            <button type="button" id="fs1" onclick="setFormShift(1)">2nd</button>
            <button type="button" id="fs2" onclick="setFormShift(2)">3rd</button>
        </div>
        <input id="route" placeholder="Route Name">
        <input id="driverName" placeholder="Driver Name">
        <input id="driverNo" type="tel" placeholder="Driver Phone">
        <input id="pickupTime" placeholder="Pickup Time (e.g. 08:30 AM)">
        <button id="saveBtn" onclick="saveDriver()">Save Driver Details</button>
    </div>

    <div class="card" style="position: sticky; top: 60px; z-index: 99;">
        <input id="search" placeholder="üîç Search by name or route..." oninput="loadDrivers()">
        <div class="shift-grid" style="margin-top:10px">
            <button id="s0" class="active" onclick="setShift(0)">First</button>
            <button id="s1" onclick="setShift(1)">Second</button>
            <button id="s2" onclick="setShift(2)">Third</button>
        </div>
    </div>

    <div id="driverList"></div>
</div>

<script>
/* ===== FIREBASE CONFIG ===== */
const firebaseConfig={
    apiKey: "AIzaSyAkxDtJ537bHtAf6i96XW7eY-t8WUapOOs",
    authDomain: "mybuspass-b222d.firebaseapp.com",
    databaseURL: "https://mybuspass-b222d-default-rtdb.firebaseio.com",
    projectId: "mybuspass-b222d",
    storageBucket: "mybuspass-b222d.firebasestorage.app",
    messagingSenderId: "275216597664",
    appId: "1:275216597664:web:9fd7443ce24ca3ffe9ffc5"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

/* AUTH */
auth.onAuthStateChanged(u=>{
    loginCard.classList.toggle("hide", !!u);
    dashboard.classList.toggle("hide", !u);
    if(u) {
        loadDrivers();
        setFormShift(0);
    }
});

function login(){ auth.signInWithEmailAndPassword(email.value, password.value).catch(e=>alert(e.message)) }
function logout(){ auth.signOut() }

/* GLOBAL STATE */
let currentShift=0;
let formShift=0;
const today=new Date().toISOString().slice(0,10);

/* SHIFT HELPERS */
function setShift(s){
    currentShift=s;
    document.querySelectorAll(".shift-grid:last-of-type button").forEach(b=>b.classList.remove("active"));
    document.getElementById("s"+s).classList.add("active");
    loadDrivers();
}

function setFormShift(s){
    formShift=s;
    document.querySelectorAll(".shift-grid:first-of-type button").forEach(b=>b.classList.remove("active"));
    document.getElementById("fs"+s).classList.add("active");
}

/* UI RENDERER */
function loadDrivers(){
    db.ref("drivers/shift"+currentShift).on("value",snap=>{
        let html="";
        const q=search.value.toLowerCase();
        
        snap.forEach(c=>{
            const d=c.val();
            if(q && !(`${d.route}${d.driverName}${d.driverNo}`.toLowerCase().includes(q))) return;
            
            const calledToday = d.lastCallDate === today;
            
            html += `
            <div class="card driver-card ${calledToday ? 'called' : ''}">
                <div class="status-badge" style="color:${calledToday ? 'green' : 'orange'}">
                    ${calledToday ? '‚úì Called' : '‚óè Pending'}
                </div>
                <div class="route-tag">Route: ${d.route}</div>
                <div class="name">${d.driverName}</div>
                <div class="info">
                    üìû ${d.driverNo} <br>
                    ‚è∞ Pickup: ${d.pickupTime}
                </div>
                <div class="actions">
                    ${calledToday ? 
                        `<button class="outline" onclick="callDriver('${c.key}','${d.driverNo}')">Recall</button>` : 
                        `<button class="green" onclick="callDriver('${c.key}','${d.driverNo}')">Call</button>`
                    }
                    <button class="outline" onclick='editDriver("${c.key}",${JSON.stringify(d)})'>Edit</button>
                    <button class="red" onclick="deleteDriver('${c.key}')">Del</button>
                </div>
            </div>`;
        });
        driverList.innerHTML = html || `<div style="text-align:center; padding:20px; color:#64748b;">No drivers found for this shift.</div>`;
    });
}

/* CRUD LOGIC */
function saveDriver(){
    const data={
        route: route.value,
        driverName: driverName.value,
        driverNo: driverNo.value,
        pickupTime: pickupTime.value,
        lastCallDate: editKey.value ? "" : "" // Logic to keep or clear
    };

    if(!data.driverName || !data.driverNo) return alert("Name and Phone are required");

    if(editKey.value)
        db.ref(`drivers/shift${formShift}/${editKey.value}`).update(data);
    else
        db.ref(`drivers/shift${formShift}`).push(data);

    // Reset Form
    editKey.value="";
    route.value=driverName.value=driverNo.value=pickupTime.value="";
    document.getElementById('saveBtn').innerText = "Save Driver Details";
}

function editDriver(key, d){
    editKey.value=key;
    route.value=d.route;
    driverName.value=d.driverName;
    driverNo.value=d.driverNo;
    pickupTime.value=d.pickupTime;
    setFormShift(currentShift);
    document.getElementById('saveBtn').innerText = "Update Driver";
    window.scrollTo({top: 0, behavior: 'smooth'});
}

function deleteDriver(key){
    if(confirm("Are you sure you want to delete this driver?"))
        db.ref(`drivers/shift${currentShift}/${key}`).remove();
}

function callDriver(key, phone){
    window.location.href="tel:"+phone;
    db.ref(`drivers/shift${currentShift}/${key}`).update({
        lastCallDate: today,
        callTime: new Date().toLocaleTimeString(),
        callDate: new Date().toLocaleDateString()
    });
}

/* EXCEL TOOLS */
function uploadExcel(){
    const file=excel.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>{
        const wb=XLSX.read(e.target.result,{type:"binary"});
        const rows=XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
        rows.forEach(r=>{
            db.ref(`drivers/shift${(r.shiftNo || 1)-1}`).push({
                route: r.route || "N/A",
                driverName: r.driverName || "Unknown",
                driverNo: r.driverNo || "000",
                pickupTime: r.pickupTime || "-",
                lastCallDate: ""
            });
        });
        alert("Imported " + rows.length + " drivers.");
    };
    reader.readAsBinaryString(file);
}

function exportCSV(){
    const rows=[["Shift","Route","Name","Phone","Pickup","Call Date","Call Time"]];
    db.ref("drivers").once("value",s=>{
        s.forEach(sh=>{
            sh.forEach(d=>{
                const v=d.val();
                if(v.lastCallDate===today)
                    rows.push([sh.key, v.route, v.driverName, v.driverNo, v.pickupTime, v.callDate, v.callTime]);
            });
        });
        const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `Report_${today}.csv`);
        document.body.appendChild(link);
        link.click();
    });
}
</script>

</body>
</html>
